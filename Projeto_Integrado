#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <unistd.h>

typedef struct {
  int hh, mm;
} Time;

int to_minutes(Time t) { return t.hh * 60 + t.mm; }

int diff_minutes(Time start, Time end) {
  int a = to_minutes(start);
  int b = to_minutes(end);
  if (b >= a)
    return b - a;
  return (24 * 60 - a) + b;
}

int is_night_extra(Time fim, double horas_extras) {
  int start = to_minutes(fim);
  int end = (start + (int)(horas_extras * 60)) % (24 * 60);
  for (int t = start; t != end; t = (t + 1) % (24 * 60))
    if (t >= 22 * 60 || t < 5 * 60)
      return 1;
  return 0;
}

int mes_atual() {
  time_t t = time(NULL);
  struct tm *data = localtime(&t);
  return data->tm_mon + 1;
}

void checar_reset_csv() {
  FILE *meta = fopen("meta.txt", "r");
  int mes_reg = -1;

  if (meta) {
    fscanf(meta, "%d", &mes_reg);
    fclose(meta);
  }

  int mes_agora = mes_atual();

  if (mes_reg != mes_agora) {
    char novo_nome[50];
    time_t t = time(NULL);
    struct tm *d = localtime(&t);

    sprintf(novo_nome, "registros_%02d_%d.csv", d->tm_mon + 1,
            d->tm_year + 1900);

    rename("solicitacoes.csv", novo_nome);

    FILE *novo = fopen("solicitacoes.csv", "w");
    if (novo) {
      fprintf(novo, "ID,Nome,Salario,Horas_trabalhadas,Horas_extras,Tipo,"
                    "Autorizado,Motivo,Valor_estimado\n");
      fclose(novo);
    }

    meta = fopen("meta.txt", "w");
    fprintf(meta, "%d", mes_agora);
    fclose(meta);
  }
}

double buscar_salario_por_id(const char *id) {
  FILE *f = fopen("solicitacoes.csv", "r");
  if (!f)
    return -1;

  char linha[256];
  fgets(linha, sizeof(linha), f);

  double salario = -1;
  char id_csv[50];

  while (fgets(linha, sizeof(linha), f)) {
    char nome[100], tipo[20], autorizado[10], motivo[200];
    double s, ht, he, valor;

    sscanf(linha, "%[^,],%*[^,],%lf,%lf,%lf,%[^,],%[^,],%[^,],%lf", id_csv, &s,
           &ht, &he, tipo, autorizado, motivo, &valor);

    if (strcmp(id_csv, id) == 0)
      salario = s;
  }

  fclose(f);
  return salario;
}

double ler_horas_extras_mes() {
  FILE *f = fopen("solicitacoes.csv", "r");
  if (!f)
    return 0.0;

  char linha[256];
  fgets(linha, sizeof(linha), f);

  double total = 0.0;

  while (fgets(linha, sizeof(linha), f)) {
    double he;
    char autorizado[10];

    sscanf(linha, "%*[^,],%*[^,],%*lf,%*lf,%lf,%*[^,],%[^,]", &he, autorizado);

    if (strcmp(autorizado, "SIM") == 0)
      total += he;
  }
  fclose(f);
  return total;
}

void salvar_solicitacao(const char *id, const char *nome, double salario,
                        double ht, double he, const char *tipo,
                        const char *motivo, double valor) {

  FILE *f = fopen("solicitacoes.csv", "a");

  if (!f) {
    f = fopen("solicitacoes.csv", "w");
    fprintf(f, "ID,Nome,Salario,Horas_trabalhadas,Horas_extras,Tipo,Autorizado,"
               "Motivo,Valor_estimado\n");
  }

  fprintf(f, "%s,%s,%.2f,%.2f,%.2f,%s,PENDENTE,%s,%.2f\n", id, nome, salario,
          ht, he, tipo, motivo, valor);

  fclose(f);
}

void atualizar_status_csv(const char *id_alvo, const char *novo_status,
                          const char *novo_motivo) {
  FILE *f = fopen("solicitacoes.csv", "r");
  if (!f) {
    printf("\033[31mNenhum arquivo de solicitacoes encontrado.\033[0m\n");
    return;
  }

  FILE *temp = fopen("temp.csv", "w");

  char linha[300];
  fgets(linha, sizeof(linha), f);
  fprintf(temp, "%s", linha);

  while (fgets(linha, sizeof(linha), f)) {
    char id_csv[50];
    char nome[100], tipo[20], autorizado[20], motivo[200];
    double salario, ht, he, valor;

    sscanf(linha, "%[^,],%[^,],%lf,%lf,%lf,%[^,],%[^,],%[^,],%lf", id_csv, nome,
           &salario, &ht, &he, tipo, autorizado, motivo, &valor);

    if (strcmp(id_csv, id_alvo) == 0) {
      fprintf(temp, "%s,%s,%.2f,%.2f,%.2f,%s,%s,%s,%.2f\n", id_csv, nome,
              salario, ht, he, tipo, novo_status, novo_motivo, valor);
    } else {
      fprintf(temp, "%s", linha);
    }
  }

  fclose(f);
  fclose(temp);

  remove("solicitacoes.csv");
  rename("temp.csv", "solicitacoes.csv");
}

// Fun√ß√£o para anima√ß√£o de carregamento simples
void loading_animation(const char *message) {
  printf("\033[34m%s\033[0m", message);
  for (int i = 0; i < 3; i++) {
    printf(".");
    fflush(stdout);
    usleep(500000); // 0.5 segundos
  }
  printf("\n");
}

// Fun√ß√£o para imprimir logo ASCII da Base27
void print_logo() {
  printf("\033[32m");
  printf("         Base27 - Sistema de Horas Extras üöÄ\n");
  printf("\033[0m\n");
}

// Fun√ß√£o para imprimir caixas ao redor do texto
void print_box(const char *text) {
  int len = strlen(text);
  printf("‚îå");
  for (int i = 0; i < len + 2; i++)
    printf("‚îÄ");
  printf("‚îê\n");
  printf("‚îÇ %s ‚îÇ\n", text);
  printf("‚îî");
  for (int i = 0; i < len + 2; i++)
    printf("‚îÄ");
  printf("‚îò\n");
}

// Fun√ß√£o para imprimir tabela das solicita√ß√µes
void print_table_header() {
  printf("\033["
         "34m‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
         "‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨"
         "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\033[0m\n");
  printf("\033[34m‚îÇ %-10s ‚îÇ %-18s ‚îÇ %-10s ‚îÇ %-16s ‚îÇ %-12s ‚îÇ %-6s ‚îÇ %-10s ‚îÇ "
         "%-28s ‚îÇ %-14s ‚îÇ\033[0m\n",
         "ID", "Nome", "Salario", "Horas Trab.", "Horas Extras", "Tipo",
         "Autorizado", "Motivo", "Valor Estimado");
  printf("\033["
         "34m‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
         "‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº"
         "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§\033[0m\n");
}

void print_table_row(const char *id, const char *nome, double salario,
                     double ht, double he, const char *tipo,
                     const char *autorizado, const char *motivo, double valor) {
  printf("‚îÇ %-10s ‚îÇ %-18s ‚îÇ %-10.2f ‚îÇ %-16.2f ‚îÇ %-12.2f ‚îÇ %-6s ‚îÇ %-10s ‚îÇ %-28s "
         "‚îÇ %-14.2f ‚îÇ\n",
         id, nome, salario, ht, he, tipo, autorizado, motivo, valor);
}

void print_table_footer() {
  printf("\033["
         "34m‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
         "‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥"
         "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\033[0m\n");
}

void menu_funcionario() {
  print_box("üë§ Menu do Funcion√°rio");
  char id[20], nome[100];
  double salario;
  Time inicio, fim, proxima;
  double horas_extras;

  printf("\033[32müìù Numero de matricula: \033[0m");
  fgets(id, sizeof(id), stdin);
  id[strcspn(id, "\n")] = 0;

  printf("\033[32müë§ Nome: \033[0m");
  fgets(nome, sizeof(nome), stdin);
  nome[strcspn(nome, "\n")] = 0;

  salario = buscar_salario_por_id(id);

  if (salario < 0) {
    printf(
        "\033[31müí∞ Salario nao encontrado. Informe o salario mensal: \033[0m");
    scanf("%lf", &salario);
  } else {
    printf("\033[32müí∞ Salario encontrado: %.2f\n\033[0m", salario);
  }

  printf("\033[32müïí Inicio (HH:MM): \033[0m");
  scanf("%d:%d", &inicio.hh, &inicio.mm);
  printf("\033[32müïí Fim (HH:MM): \033[0m");
  scanf("%d:%d", &fim.hh, &fim.mm);
  printf("\033[32müïí Proxima jornada (HH:MM): \033[0m");
  scanf("%d:%d", &proxima.hh, &proxima.mm);
  printf("\033[32m‚è∞ Horas extras pretendidas: \033[0m");
  scanf("%lf", &horas_extras);

  getchar();

  double ht = diff_minutes(inicio, fim) / 60.0;
  double descanso = diff_minutes(fim, proxima) / 60.0;
  double horas_mes = ler_horas_extras_mes();

  // Verifica√ß√µes autom√°ticas de nega√ß√£o conforme lei (CLT: at√© 2h/dia, 40h/m√™s)
  if (horas_extras > 2.0) {
    printf("\033[31m‚ùå Solicitacao negada automaticamente: Excede limite diario "
           "de 2 horas extras.\033[0m\n");
    salvar_solicitacao(id, nome, salario, ht, horas_extras, "Diurna",
                       "Excede limite diario de 2 horas extras", 0.0);
    atualizar_status_csv(id, "NAO", "Excede limite diario de 2 horas extras");
    return;
  }
  if (horas_mes + horas_extras > 40.0) {
    printf("\033[31m‚ùå Solicitacao negada automaticamente: Excede limite mensal "
           "de 40 horas extras.\033[0m\n");
    salvar_solicitacao(id, nome, salario, ht, horas_extras, "Diurna",
                       "Excede limite mensal de 40 horas extras", 0.0);
    atualizar_status_csv(id, "NAO", "Excede limite mensal de 40 horas extras");
    return;
  }

  double valor_hora = salario / 220.0;
  double valor_extra = valor_hora * 1.5;
  double valor_extra_not = valor_extra * 1.25;

  int noturna = is_night_extra(fim, horas_extras);
  char tipo[20] = "Diurna";
  if (noturna)
    strcpy(tipo, "Noturna");

  double valor_estimado =
      noturna ? horas_extras * valor_extra_not : horas_extras * valor_extra;

  loading_animation("üì§ Salvando solicitacao");
  salvar_solicitacao(id, nome, salario, ht, horas_extras, tipo,
                     "Aguardando avaliacao do gestor", valor_estimado);

  printf("\033[32m‚úÖ As informacoes foram enviadas ao gestor e serao "
         "analisadas.\033[0m\n");
}

void menu_gestor() {
  print_box("üë®‚Äçüíº Menu do Gestor");
  char senha[20];

  printf("\033[32müîê Senha do gestor: \033[0m");
  fgets(senha, sizeof(senha), stdin);
  senha[strcspn(senha, "\n")] = 0;

  if (strcmp(senha, "admin") != 0) {
    printf("\033[31m‚ùå Senha incorreta.\033[0m\n");
    return;
  }

  FILE *f = fopen("solicitacoes.csv", "r");
  if (!f) {
    printf("\033[31müìÅ Nenhum arquivo de solicitacoes encontrado.\033[0m\n");
    return;
  }

  char linha[300];
  fgets(linha, sizeof(linha), f);

  printf("\033[34m\nüìã Solicitacoes pendentes:\n\033[0m");
  print_table_header();

  while (fgets(linha, sizeof(linha), f)) {
    char id_csv[50], nome[100], tipo[20], autorizado[20], motivo[200];
    double salario, ht, he, valor;

    sscanf(linha, "%[^,],%[^,],%lf,%lf,%lf,%[^,],%[^,],%[^,],%lf", id_csv, nome,
           &salario, &ht, &he, tipo, autorizado, motivo, &valor);

    if (strcmp(autorizado, "PENDENTE") == 0) {
      print_table_row(id_csv, nome, salario, ht, he, tipo, autorizado, motivo,
                      valor);
    }
  }

  print_table_footer();
  fclose(f);

  char id_decisao[20];
  char escolha[5];

  printf("\033[32müîç Digite o ID para decidir: \033[0m");
  fgets(id_decisao, sizeof(id_decisao), stdin);
  id_decisao[strcspn(id_decisao, "\n")] = 0;

  // Verificar novamente no gestor se excede (embora j√° verificado no
  // funcion√°rio, para seguran√ßa)
  double horas_mes = ler_horas_extras_mes();
  double he_solicitada = 0.0;
  f = fopen("solicitacoes.csv", "r");
  fgets(linha, sizeof(linha), f);
  while (fgets(linha, sizeof(linha), f)) {
    char id_csv[50];
    sscanf(linha, "%[^,]", id_csv);
    if (strcmp(id_csv, id_decisao) == 0) {
      sscanf(linha, "%*[^,],%*[^,],%*lf,%*lf,%lf", &he_solicitada);
      break;
    }
  }
  fclose(f);

  if (horas_mes + he_solicitada > 40.0) {
    printf("\033[31m‚ùå Solicitacao negada automaticamente: Excede limite mensal "
           "de 40 horas extras.\033[0m\n");
    atualizar_status_csv(id_decisao, "NAO",
                         "Excede limite mensal de 40 horas extras");
    return;
  }

  printf("\033[32m‚úÖ Aprovar (S) ou Negar (N): \033[0m");
  fgets(escolha, sizeof(escolha), stdin);

  loading_animation("üîÑ Atualizando status");
  if (escolha[0] == 'S' || escolha[0] == 's') {
    atualizar_status_csv(id_decisao, "SIM", "Aprovado pelo gestor");
    printf("\033[32m‚úÖ Solicitacao aprovada.\033[0m\n");
  } else {
    atualizar_status_csv(id_decisao, "NAO", "Negado pelo gestor");
    printf("\033[31m‚ùå Solicitacao negada.\033[0m\n");
  }
}

int main() {
  checar_reset_csv();
  print_logo();

  int op;

  do {
    print_box("üè† Menu Principal");
    printf("\033[34m1 - üë§ Menu funcionario\n\033[0m");
    printf("\033[34m2 - üë®‚Äçüíº Menu gestor\n\033[0m");
    printf("\033[31m0 - üö™ Sair\n\033[0m");
    printf("\033[32müî¢ Opcao: \033[0m");
    scanf("%d", &op);
    getchar();

    if (op == 1)
      menu_funcionario();
    else if (op == 2)
      menu_gestor();

  } while (op != 0);

  return 0;
}
